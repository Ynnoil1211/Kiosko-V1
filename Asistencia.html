<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Control de Asistencia - Restaurante</title>
    <style>
        :root{
            --primary:#102027; --accent:#ffb74d; --success:#27ae60; --danger:#e74c3c;
            --muted:#7f8c8d; --card:#ffffff; --bg:#f4f7fa;
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0;
            font-family: Inter, "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
            background: linear-gradient(180deg, #eef6f9 0%, var(--bg) 100%);
            display:flex; align-items:center; justify-content:center;
            padding:28px; user-select:none;
        }

        /* Layout general */
        .kiosk{
            width:100%; max-width:920px;
            display:grid; grid-template-columns: 1fr 420px;
            gap:28px; align-items:start;
        }

        /* Left column - info / clock */
        .panel-left{
            background: linear-gradient(180deg, rgba(16,32,39,0.98), rgba(26,58,63,0.98));
            color:white; border-radius:16px; padding:28px;
            box-shadow:0 12px 30px rgba(16,32,39,0.12);
            display:flex; flex-direction:column; gap:18px; min-height:350px;
        }
        .brand{ display:flex; align-items:center; gap:14px; }
        .logo{
            width:68px; height:68px; border-radius:12px;
            background:linear-gradient(135deg,var(--accent),#ff8a65);
            display:flex; align-items:center; justify-content:center;
            font-weight:800; color:#102027; font-size:20px;
            box-shadow:0 6px 18px rgba(0,0,0,0.18);
        }
        .brand h1{ margin:0; font-size:20px; letter-spacing:1px; }
        .brand p{ margin:0; color:rgba(255,255,255,0.85); font-size:13px; }

        .clock-card{
            background:rgba(255,255,255,0.06); padding:22px;
            border-radius:12px; display:flex; justify-content:space-between; align-items:center;
        }
        .clock{ font-size:48px; font-weight:700; letter-spacing:1.5px; }
        .date{ text-align:right; color:rgba(255,255,255,0.85); font-weight:600; font-size:14px; }

        .status-bar{
            border-radius:10px; padding:12px 16px; font-weight:700;
            text-align:center; font-size:15px; transition: all 0.3s ease;
        }
        .online{ background:rgba(39,174,96,0.12); color:var(--success); border: 1px solid rgba(39,174,96,0.3); }
        .offline{ background:rgba(231,76,60,0.15); color:var(--danger); border: 1px solid rgba(231,76,60,0.3); }

        .left-footer{
            margin-top:auto; display:flex; gap:12px;
            align-items:center; justify-content:space-between;
            color:rgba(255,255,255,0.9); font-size:13px;
        }

        /* Right column - main controls */
        .panel-right{
            background:var(--card); border-radius:16px; padding:28px;
            box-shadow:0 12px 30px rgba(2,6,23,0.06);
            display:flex; flex-direction:column; gap:18px; min-height:350px;
        }

        .select-wrap{ position:relative; }
        label.small{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }

        select, input[type="password"]{
            width:100%; padding:16px 18px; border-radius:12px;
            border:1px solid #e6eef2; font-size:16px; outline:none; background:transparent;
        }
        select:focus, input:focus{ border-color: var(--accent); box-shadow:0 0 0 4px rgba(255, 183, 77, 0.2); }

        .employee-row{ display:flex; gap:12px; align-items:center; }
        .avatar{
            width:64px; height:64px; border-radius:12px; background:#ecf0f1;
            display:flex; align-items:center; justify-content:center;
            font-weight:700; color:#2c3e50; font-size:20px; flex-shrink:0;
            border:1px solid #e9eef0; transition: background 0.3s;
        }

        .controls{ display:flex; gap:18px; margin-top:8px; }
        .btn{
            flex:1; padding:22px; border-radius:12px; border:none;
            font-size:18px; font-weight:800; color:white; cursor:pointer;
            text-transform:uppercase; letter-spacing:0.6px;
            box-shadow:0 8px 20px rgba(16,32,39,0.08);
            transition:transform .08s ease, box-shadow .12s ease;
        }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn:active{ transform:translateY(2px); box-shadow: none; }
        .btn-in{ background:linear-gradient(90deg,var(--success), #2ecc71); }
        .btn-out{ background:linear-gradient(90deg,var(--danger), #ff6b6b); }

        .msg-area{
            margin-top:6px; min-height:42px; font-size:16px;
            font-weight:700; text-align:center; padding: 10px; border-radius: 8px;
        }

        .admin-panel{
            display:flex; gap:12px; align-items:center; justify-content:space-between; margin-top:8px;
        }
        .btn-small{
            padding:10px 14px; background:#2d3e50; color:white;
            border-radius:10px; border:none; cursor:pointer; font-size: 13px;
        }
        .btn-small:hover{ background:#34495e; }

        @media (max-width:900px){
            .kiosk{ grid-template-columns:1fr; max-width:680px; }
            .brand h1{ font-size:18px; }
            .clock{ font-size:42px; }
        }
    </style>
</head>
<body>
    <div class="kiosk">
        <section class="panel-left">
            <div class="brand">
                <div class="logo">RA</div>
                <div>
                    <h1 id="kiosk-title">CONTROL DE ASISTENCIA ‚Äî CANTON GOURMET</h1>
                    <p>Sistema de registro en punto fijo v4.0</p>
                </div>
            </div>

            <div class="clock-card">
                <div>
                    <div style="font-size:12px;color:rgba(255,255,255,0.7);font-weight:700">HORA ACTUAL</div>
                    <div class="clock" id="clock">00:00:00</div>
                </div>
                <div class="date" id="date">--</div>
            </div>

            <div id="connection-status" class="status-bar online">üü¢ CONECTADO</div>

            <div class="left-footer">
                <div style="display:flex;gap:10px;align-items:center">
                    <div style="font-size:13px">ID: <strong>PC_RECEPCION_01</strong></div>
                </div>
                <div style="font-size:13px;color:rgba(255,255,255,0.85)">
                   <button onclick="cargarEmpleados()" style="background:none;border:none;color:white;cursor:pointer;text-decoration:underline">Act. Personal</button>
                </div>
            </div>
        </section>

        <section class="panel-right">
            <div class="select-wrap">
                <label class="small" for="employeeSelect">Colaborador</label>
                <select id="employeeSelect">
                    <option value="" disabled selected>-- CARGANDO PERSONAL... --</option>
                </select>
            </div>

            <div>
                <label class="small" for="pinInput">C√≥digo de Acceso (PIN)</label>
                <input type="password" id="pinInput" placeholder="PIN (4 d√≠gitos)" maxlength="4">
            </div>

            <div class="employee-row">
                <div class="avatar" id="avatarPreview">?</div>
                <div style="flex:1">
                    <div style="font-weight:800;font-size:16px" id="selectedName">Sin selecci√≥n</div>
                    <div style="color:var(--muted);font-size:13px">Selecciona tu nombre arriba</div>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-in" onclick="registrar('ENTRADA')">ENTRADA</button>
                <button class="btn btn-out" onclick="registrar('SALIDA')">SALIDA</button>
            </div>

            <div id="msg-area" class="msg-area"></div>

            <div class="admin-panel">
                <div id="queue-count" style="font-weight:bold; color:var(--muted)">Pendientes: 0</div>
                <div style="display:flex;gap:8px">
                    <button class="btn-small" onclick="descargarCSV()">üíæ Backup</button>
                    <button class="btn-small" onclick="location.reload()">üîÅ Reset</button>
                </div>
            </div>
        </section>
    </div>

    <script>
        /**
         * CONFIGURACI√ìN DEL SISTEMA
         * ¬°IMPORTANTE! Actualiza WEB_APP_URL con el nuevo enlace del despliegue
         */
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzr0SJ_xzdsp5GQ-8PcfnFtrzFFrt4PFWQK41DX4bGxNEWwH1SG_kHBxuZ1QdLfU_GU/exec";
        const API_TOKEN = "CANTON2026";
        const DEVICE_ID = "PC_RECEPCION_01";

        let EMPLOYEES = [];

        // --- INICIALIZACI√ìN ---

        // 1. Cargar empleados (Red -> LocalStorage -> UI)
        async function cargarEmpleados() {
            const select = document.getElementById('employeeSelect');
            const localData = localStorage.getItem('cached_employees');

            // Si tenemos datos viejos, los mostramos primero para que sea r√°pido
            if (localData) {
                EMPLOYEES = JSON.parse(localData);
                renderSelect();
            }

            if (navigator.onLine) {
                try {
                    // Petici√≥n al nuevo endpoint doGet
                    const response = await fetch(`${WEB_APP_URL}?action=getEmployees`);
                    const data = await response.json();

                    if (Array.isArray(data) && data.length > 0) {
                        EMPLOYEES = data;
                        localStorage.setItem('cached_employees', JSON.stringify(data)); // Guardar backup
                        renderSelect();
                        console.log("‚úÖ Lista de personal actualizada desde servidor");
                    }
                } catch (e) {
                    console.warn("‚ö†Ô∏è No se pudo actualizar personal (Usando cach√© local)", e);
                    if (EMPLOYEES.length === 0) {
                        select.innerHTML = '<option disabled selected>‚ö†Ô∏è Error de Conexi√≥n</option>';
                    }
                }
            }
        }

        function renderSelect() {
            const select = document.getElementById('employeeSelect');
            select.innerHTML = '<option value="" disabled selected>-- BUSCA TU NOMBRE --</option>';

            EMPLOYEES.forEach(emp => {
                let opt = document.createElement('option');
                opt.value = emp.id;
                opt.text = `${emp.id} ‚Äî ${emp.name}`;
                select.appendChild(opt);
            });
        }

        // 2. Reloj
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString();
            document.getElementById('date').innerText = now.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }, 1000);

        // 3. Listeners
        document.getElementById('pinInput').addEventListener('input', function (e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
        document.getElementById('pinInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') registrar('ENTRADA');
        });

        // L√≥gica visual de Avatar
        const select = document.getElementById('employeeSelect');
        const selectedName = document.getElementById('selectedName');
        const avatar = document.getElementById('avatarPreview');

        select.addEventListener('change', () => {
            const opt = select.options[select.selectedIndex];
            const rawName = opt.text.split('‚Äî')[1]?.trim() || "Usuario";
            selectedName.innerText = rawName;

            const parts = rawName.split(' ');
            let initials = parts.length === 1 ? parts[0].slice(0,2) : (parts[0][0] + (parts[1]?.[0]||'')).toUpperCase();
            avatar.innerText = initials;
            avatar.style.backgroundColor = stringToColor(rawName);
            avatar.style.color = "#fff";
        });

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        // --- L√ìGICA DE RED Y SINCRONIZACI√ìN ---

        function updateStatus() {
            const statusDiv = document.getElementById('connection-status');
            if (navigator.onLine) {
                statusDiv.className = "status-bar online";
                statusDiv.innerText = "üü¢ CONECTADO - EN L√çNEA";
                procesarCola();
                // Intentar actualizar lista de empleados al volver online
                if(EMPLOYEES.length === 0) cargarEmpleados();
            } else {
                statusDiv.className = "status-bar offline";
                statusDiv.innerText = "üî¥ SIN CONEXI√ìN (Modo Local)";
            }
        }
        window.addEventListener('online', updateStatus);
        window.addEventListener('offline', updateStatus);

        async function registrar(tipo) {
            const empId = document.getElementById('employeeSelect').value;
            const pin = document.getElementById('pinInput').value;
            const btns = document.querySelectorAll('.btn');

            btns.forEach(b => b.disabled = true);

            if (!empId) {
                feedback("‚ö†Ô∏è Selecciona tu nombre primero", "orange");
                btns.forEach(b => b.disabled = false);
                return;
            }
            if (!pin || pin.length < 3) {
                feedback("‚ö†Ô∏è Ingresa tu PIN completo", "orange");
                btns.forEach(b => b.disabled = false);
                return;
            }

            const registro = {
                uuid: generateUUID(),
                empleadoId: empId,
                pin: pin,
                tipo: tipo,
                fechaLocal: new Date().toISOString(),
                dispositivo: DEVICE_ID,
                token: API_TOKEN,
                isOffline: !navigator.onLine
            };

            feedback("‚è≥ Procesando...", "#2c3e50");

            if (navigator.onLine) {
                try {
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST',
                        body: JSON.stringify(registro)
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        feedback(`‚úÖ √âXITO: ${tipo} REGISTRADA`, "green");
                        limpiarInputs();
                    } else {
                        feedback(`‚ùå RECHAZADO: ${result.message}`, "red");
                        document.getElementById('pinInput').value = "";
                    }
                } catch (e) {
                    console.error(e);
                    feedback("‚ö†Ô∏è Red inestable. Guardando localmente...", "#d35400");
                    setTimeout(() => guardarLocal(registro), 1000);
                }
            } else {
                guardarLocal(registro);
            }

            setTimeout(() => { btns.forEach(b => b.disabled = false); }, 2500);
        }

        function guardarLocal(registro) {
            registro.isOffline = true;
            let cola = JSON.parse(localStorage.getItem('cola_asistencia') || "[]");
            cola.push(registro);
            localStorage.setItem('cola_asistencia', JSON.stringify(cola));
            actualizarContadorCola();
            feedback(`üíæ GUARDADO OFFLINE (${registro.tipo})`, "#c0392b");
            limpiarInputs();
        }

        function feedback(txt, color) {
            const m = document.getElementById('msg-area');
            m.innerText = txt;
            m.style.color = color;
            m.style.backgroundColor = color === "green" ? "#d4edda" : (color === "red" ? "#f8d7da" : "transparent");
        }

        function limpiarInputs() {
            setTimeout(() => {
                document.getElementById('employeeSelect').value = "";
                document.getElementById('pinInput').value = "";
                document.getElementById('msg-area').innerText = "";
                document.getElementById('msg-area').style.backgroundColor = "transparent";
                document.getElementById('selectedName').innerText = "Sin selecci√≥n";
                document.getElementById('avatarPreview').innerText = "?";
                document.getElementById('avatarPreview').style.backgroundColor = "#ecf0f1";
                document.getElementById('avatarPreview').style.color = "#2c3e50";
            }, 2500);
        }

        async function procesarCola() {
            let cola = JSON.parse(localStorage.getItem('cola_asistencia') || "[]");
            if (cola.length === 0) return;

            document.getElementById('msg-area').innerText = `üîÑ Sincronizando ${cola.length} registros...`;

            let colaFallida = [];
            let exitoCount = 0;

            for (let i = 0; i < cola.length; i++) {
                let reg = cola[i];
                try {
                    const resp = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(reg) });
                    // Si el servidor responde (aunque sea error de PIN), lo contamos como procesado
                    // para sacarlo de la cola y no bloquear al resto.
                    exitoCount++;
                } catch (e) {
                    console.log("Fallo sincronizaci√≥n red, parando.");
                    colaFallida = cola.slice(i);
                    break;
                }
            }

            localStorage.setItem('cola_asistencia', JSON.stringify(colaFallida));
            actualizarContadorCola();

            if (colaFallida.length === 0 && exitoCount > 0) {
                feedback("‚úÖ Sincronizaci√≥n completa", "green");
                setTimeout(() => { document.getElementById('msg-area').innerText = ""; }, 3000);
            }
        }

        function actualizarContadorCola() {
            const count = JSON.parse(localStorage.getItem('cola_asistencia') || "[]").length;
            document.getElementById('queue-count').innerText = `Pendientes: ${count}`;
        }

        function descargarCSV() {
            let cola = JSON.parse(localStorage.getItem('cola_asistencia') || "[]");
            if (cola.length === 0) { alert("No hay datos pendientes."); return; }
            let csvContent = "data:text/csv;charset=utf-8,ID,Fecha,Tipo\n";
            cola.forEach(row => { csvContent += `${row.empleadoId},${row.fechaLocal},${row.tipo}\n`; });
            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "respaldo_asistencia_offline.csv");
            document.body.appendChild(link);
            link.click();
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Init
        cargarEmpleados();
        actualizarContadorCola();
        updateStatus();
    </script>
</body>
</html>
